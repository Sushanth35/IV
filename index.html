<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grocery Store Survey Dashboard</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: black; color: white; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 3em; font-weight: bold; color: white; }
    .filter { margin-bottom: 20px; text-align: center; }
    label { color: white; }
    select { background-color: black; color: white; border: 1px solid gray; }
    .charts-row { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
    .chart { width: 30%; background: #111; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(255,255,255,0.1); margin-bottom: 20px; min-height: 460px; position: relative; }
    svg { width: 100%; height: 400px; background: transparent; }
    text, .tick text { fill: white; } /* Axes and titles in white */
    .footer { text-align: center; margin-top: 40px; font-size: 0.9em; color: gray; }
    .tooltip { position: absolute; text-align: center; padding: 6px; font-size: 12px; background: lightsteelblue; border-radius: 5px; pointer-events: none; opacity: 0; color: black; }
    .no-data { text-align: center; color: gray; padding-top: 100px; font-size: 18px; }
  </style>
</head>

<body>

  <div class="header">
    <h1>Grocery Store Survey Dashboard</h1>
  </div>

  <div class="filter">
    <label for="genderFilter">Filter by Gender:</label>
    <select id="genderFilter"><option value="All">All</option></select>
    <label for="paymentFilter" style="margin-left:20px;">Filter by Payment Method:</label>
    <select id="paymentFilter"><option value="All">All</option></select>
    <label for="chainFilter" style="margin-left:20px;">Filter by Chain:</label>
    <select id="chainFilter"><option value="All">All</option></select>
  </div>

  <div class="charts-row">
    <div class="chart" id="barChart"></div>
    <div class="chart" id="pieChart"></div>
    <div class="chart" id="boxPlot"></div> <!-- Replaced scatter plot with box plot -->
  </div>

  <div class="footer">
    Created by Harshitha Patlolla, Varun Sai Arutla, Lakshmi Mattaparthi, Sushanth Malliboina
  </div>

  <div id="tooltip" class="tooltip"></div>

<script>
let data;
const tooltip = d3.select("#tooltip");

// Load data
d3.csv("a1-grocerystoresurvey.csv").then(rawData => {
  data = rawData;
  console.log("Data Loaded: ", data); // Check the data loaded from the CSV

  data.forEach(d => {
    d.Age = +d.Age;
    d.Income = +d.Income;
    d.PurchaseAmount = +d.PurchaseAmount;
    d.FamilySize = +d.FamilySize;
  });
  
  // Debug: Log unique values for filters
  console.log('Unique Genders:', Array.from(new Set(data.map(d => d.Gender))));
  console.log('Unique Payment Methods:', Array.from(new Set(data.map(d => d.PaymentMethod))));
  console.log('Unique Chains:', Array.from(new Set(data.map(d => d.Chain))));

  initFilters();
  updateVisuals();
}).catch(err => {
  console.error('Error loading CSV file: ', err); // Error handling for data loading
});

function initFilters() {
  let genders = Array.from(new Set(data.map(d => d.Gender)));
  genders.forEach(g => d3.select("#genderFilter").append("option").attr("value", g).text(g));
  let payments = Array.from(new Set(data.map(d => d.PaymentMethod)));
  payments.forEach(p => d3.select("#paymentFilter").append("option").attr("value", p).text(p));
  let chains = Array.from(new Set(data.map(d => d.Chain)));
  chains.forEach(c => d3.select("#chainFilter").append("option").attr("value", c).text(c));
  d3.selectAll("select").on("change", updateVisuals);
}

function filterData() {
  let gender = d3.select("#genderFilter").property("value");
  let payment = d3.select("#paymentFilter").property("value");
  let chain = d3.select("#chainFilter").property("value");
  return data.filter(d =>
    (gender === "All" || d.Gender === gender) &&
    (payment === "All" || d.PaymentMethod === payment) &&
    (chain === "All" || d.Chain === chain)
  );
}

function showNoData(containerId) {
  d3.select(`#${containerId}`).html('<div class="no-data">No data available</div>');
}

function updateVisuals() {
  let filtered = filterData();
  console.log("Filtered Data: ", filtered); // Log filtered data for debugging
  drawBarChart(filtered);
  drawPieChart(filtered);
  drawBoxPlot(filtered); // Updated to call the box plot function
}

function drawBarChart(filtered) {
  const id = "barChart";
  d3.select(`#${id}`).html("");
  if (filtered.length === 0) { showNoData(id); return; }

  const svg = d3.select(`#${id}`).append("svg"),
        margin = {top: 20, right: 20, bottom: 50, left: 50},
        width = svg.node().clientWidth - margin.left - margin.right,
        height = svg.node().clientHeight - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const avgPurchase = d3.rollup(filtered, v => d3.mean(v, d => d.PurchaseAmount), d => d.Chain);
  const topChains = Array.from(avgPurchase).slice(0, 3);  // Show top 3 chains

  const x = d3.scaleBand().domain(topChains.map(d => d[0])).range([0, width]).padding(0.3);
  const y = d3.scaleLinear().domain([0, d3.max(topChains, d => d[1])]).nice().range([height, 0]);

  const bars = g.selectAll("rect").data(topChains).join("rect")
    .attr("x", d => x(d[0]))
    .attr("y", d => y(d[1]))
    .attr("width", x.bandwidth())
    .attr("height", d => height - y(d[1]))
    .attr("fill", "#4FC3F7")
    .style("transition", "all 0.3s ease-in-out") // Smooth transition
    .on("mouseover", (event, d) => {
      tooltip.style("opacity", 1).html(`<b>Chain:</b> ${d[0]}<br><b>Avg Purchase:</b> $${d[1].toFixed(2)}`);
      d3.select(event.target).style("fill", "#FF7043"); // Highlight bar on hover
    })
    .on("mousemove", (event) => {
      tooltip.style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", (event) => {
      tooltip.style("opacity", 0);
      d3.select(event.target).style("fill", "#4FC3F7"); // Reset bar color
    });

  g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
  g.append("g").call(d3.axisLeft(y));

  svg.append("text")
    .attr("x", width/2 + margin.left)
    .attr("y", 15)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .text("Average Purchase by Chain");
}

function drawPieChart(filtered) {
  const id = "pieChart";
  d3.select(`#${id}`).html("");  // Clear any existing chart
  if (filtered.length === 0) { showNoData(id); return; }

  const svg = d3.select(`#${id}`).append("svg"),
        width = svg.node().clientWidth,
        height = svg.node().clientHeight,
        radius = Math.min(width, height) / 2 - 20,
        g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);

  const genderCounts = d3.rollup(filtered, v => v.length, d => d.Gender);
  const pie = d3.pie().value(d => d[1]);
  const arc = d3.arc().innerRadius(0).outerRadius(radius);
  const color = d3.scaleOrdinal()
                  .domain(Array.from(genderCounts.keys()))
                  .range(["#FF7043", "#AB47BC", "#26A69A", "#29B6F6"]);

  const slices = g.selectAll("path")
    .data(pie(Array.from(genderCounts)))
    .join("path")
    .attr("d", arc)
    .attr("fill", d => color(d.data[0]))
    .attr("stroke", "#fff")
    .attr("stroke-width", 2)
    .style("transition", "all 0.3s ease-in-out")  // Smooth transition
    .on("mouseover", (event, d) => {
      tooltip.style("opacity", 1).html(`<b>Gender:</b> ${d.data[0]}<br><b>Count:</b> ${d.data[1]}`);
      d3.select(event.target).style("transform", "scale(1.1)");  // Scale slice on hover
    })
    .on("mousemove", (event) => {
      tooltip.style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", (event) => {
      tooltip.style("opacity", 0);
      d3.select(event.target).style("transform", "scale(1)");  // Reset slice size
    });

  g.selectAll("text")
    .data(pie(Array.from(genderCounts)))
    .join("text")
    .attr("transform", d => {
      const [x, y] = arc.centroid(d);
      return `translate(${x},${y})`;
    })
    .attr("text-anchor", "middle")
    .style("font-size", "14px")
    .style("fill", "white")
    .style("font-weight", "bold")
    .text(d => `${d.data[0]}: ${d.data[1]}`);

  // Add legend
  const legend = svg.append("g")
    .attr("transform", `translate(${width - 160}, 20)`); // Position legend on the right

  let legendItems = legend.selectAll(".legend")
    .data(Array.from(genderCounts))
    .join("g")
    .attr("class", "legend");

  legendItems.append("rect")
    .attr("x", 0)
    .attr("y", (d, i) => i * 25)
    .attr("width", 20)
    .attr("height", 20)
    .attr("fill", d => color(d[0]))
    .style("cursor", "pointer")
    .on("click", (event, d) => {
      const selectedGender = d[0];
      const selectedSlice = svg.selectAll("path").filter(p => p.data[0] === selectedGender);
      selectedSlice.style("opacity", selectedSlice.style("opacity") === "1" ? 0.3 : 1);  // Toggle visibility
    });

  legendItems.append("text")
    .attr("x", 30)
    .attr("y", (d, i) => i * 25 + 15)
    .style("fill", "white")
    .text(d => d[0]);

  // Title for the pie chart
  svg.append("text")
    .attr("x", width / 2)
    .attr("y", 15)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .text("Gender Distribution");
}

function drawBoxPlot(filtered) {
  const id = "boxPlot";
  d3.select(`#${id}`).html(""); // Clear any existing chart
  if (filtered.length === 0) { showNoData(id); return; }

  const svg = d3.select(`#${id}`).append("svg"),
        margin = {top: 20, right: 20, bottom: 50, left: 50},
        width = svg.node().clientWidth - margin.left - margin.right,
        height = svg.node().clientHeight - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const chainGroups = d3.groups(filtered, d => d.Chain);

  const x = d3.scaleBand()
    .domain(chainGroups.map(d => d[0]))
    .range([0, width])
    .padding(0.2);

  const y = d3.scaleLinear()
    .domain([0, d3.max(filtered, d => d.PurchaseAmount)])
    .nice()
    .range([height, 0]);

  // Draw X axis
  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x));

  // Draw Y axis
  g.append("g")
    .call(d3.axisLeft(y));

  // Create box plots for each group (Chain)
  const boxWidth = x.bandwidth();

  chainGroups.forEach(([chain, group], i) => {
    const q1 = d3.quantile(group.map(d => d.PurchaseAmount).sort(d3.ascending), 0.25);
    const median = d3.quantile(group.map(d => d.PurchaseAmount).sort(d3.ascending), 0.5);
    const q3 = d3.quantile(group.map(d => d.PurchaseAmount).sort(d3.ascending), 0.75);
    const iqr = q3 - q1;
    const lowerWhisker = Math.max(d3.min(group.map(d => d.PurchaseAmount)), q1 - 1.5 * iqr);
    const upperWhisker = Math.min(d3.max(group.map(d => d.PurchaseAmount)), q3 + 1.5 * iqr);

    // Draw the box for each chain
    g.append("rect")
      .attr("x", x(chain))
      .attr("y", y(q3))
      .attr("width", boxWidth)
      .attr("height", y(q1) - y(q3))
      .attr("fill", "#4FC3F7");

    // Draw the median line inside the box
    g.append("line")
      .attr("x1", x(chain))
      .attr("x2", x(chain) + boxWidth)
      .attr("y1", y(median))
      .attr("y2", y(median))
      .attr("stroke", "#FF7043")
      .attr("stroke-width", 2);

    // Draw the whiskers
    g.append("line")
      .attr("x1", x(chain) + boxWidth / 2)
      .attr("x2", x(chain) + boxWidth / 2)
      .attr("y1", y(lowerWhisker))
      .attr("y2", y(q1))
      .attr("stroke", "#FF7043");

    g.append("line")
      .attr("x1", x(chain) + boxWidth / 2)
      .attr("x2", x(chain) + boxWidth / 2)
      .attr("y1", y(upperWhisker))
      .attr("y2", y(q3))
      .attr("stroke", "#FF7043");

    // Optional: Draw the outliers
    group.forEach(d => {
      if (d.PurchaseAmount < lowerWhisker || d.PurchaseAmount > upperWhisker) {
        g.append("circle")
          .attr("cx", x(chain) + boxWidth / 2)
          .attr("cy", y(d.PurchaseAmount))
          .attr("r", 3)
          .attr("fill", "#FF7043");
      }
    });
  });

  svg.append("text")
    .attr("x", width / 2 + margin.left)
    .attr("y", 15)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .text("Purchase Amount Distribution by Chain");
}
</script>

</body>
</html>
